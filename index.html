<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æˆ‘çš„æ¸…å–®</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial; padding: 16px; background:#fafafa; }
    .card { border: 1px solid #e5e5e5; border-radius: 14px; padding: 12px; margin-top: 12px; background:#fff; }
    code { background:#f3f3f3; padding:2px 6px; border-radius:6px; }
    button { padding:10px 12px; border-radius:10px; border:1px solid #ddd; background:#fff; cursor:pointer; }
    button:disabled { opacity:0.6; cursor:not-allowed; }

    .list { margin-top: 12px; display:flex; flex-direction:column; gap: 10px; }
    .item {
      display:flex; align-items: stretch; gap: 12px;
      border: 1px solid #eee; border-radius: 14px; padding: 10px;
      background:#fff;
    }
    .thumb {
      width: 84px; height: 84px; border-radius: 12px; overflow:hidden;
      flex: 0 0 auto; background:#f0f0f0;
    }
    .thumb img { width:100%; height:100%; object-fit:cover; display:block; }
    .info { flex: 1 1 auto; min-width: 0; }
    .name { font-weight: 700; font-size: 15px; line-height: 1.2; margin-bottom: 6px; }
    .meta { font-size: 13px; color:#444; line-height:1.35; }
    .tags { font-size: 12px; color:#777; margin-top: 6px; white-space: nowrap; overflow:hidden; text-overflow: ellipsis; }

    .actions { display:flex; align-items:center; }
    .trash {
      width: 44px; height: 44px; border-radius: 12px;
      border: 1px solid #ffd0d0; background:#fff5f5; color:#d60000;
      display:flex; align-items:center; justify-content:center;
      font-size: 20px; cursor:pointer;
    }
    .trash:hover { background:#ffecec; }

    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .muted { color:#666; font-size: 13px; }
  </style>
</head>
<body>
  <h2>ğŸ“Œ æˆ‘çš„æ¸…å–®</h2>

  <div class="card">
    <div class="row">
      <div>LIFF ç‹€æ…‹ï¼š<span id="status">åˆå§‹åŒ–ä¸­â€¦</span></div>
      <div class="muted">isInClientï¼š<code id="inClient">-</code></div>
      <div class="muted">userIdï¼š<code id="userId">-</code></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="loginBtn" style="display:none;">ç™»å…¥ LINE</button>
      <button id="reloadBtn" style="display:none;">é‡æ–°è¼‰å…¥æ¸…å–®</button>
      <button id="closeBtn" style="display:none;">é—œé–‰é é¢</button>
    </div>
    <div id="msg" class="muted" style="margin-top:10px"></div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div>ğŸ›’ æ¸…å–®å…§å®¹</div>
      <div class="muted">å…± <span id="count">0</span> é …</div>
    </div>
    <div id="list" class="list"></div>
  </div>

  <script>
    // âœ… ä½ çš„ LIFF IDï¼ˆå¦‚æœä¹‹å¾Œæ› LIFFï¼Œåªæ”¹é€™è£¡ï¼‰
    const LIFF_ID = "2009075953-1UZ0h4p2";

    // âœ… ä½ æ¸¬è©¦æˆåŠŸçš„ API
    const GET_LIST_URL = "https://subdepressed-thistly-lee.ngrok-free.dev/webhook/list";
    const DELETE_BASE  = "https://subdepressed-thistly-lee.ngrok-free.dev/webhook/9cc8ce9b-9837-4a04-b46d-7c4f9b772ce2";

    const $ = (id) => document.getElementById(id);

    function setMsg(t) { $("msg").textContent = t || ""; }

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function renderList(items) {
      const wrap = $("list");
      wrap.innerHTML = "";
      $("count").textContent = String(items.length);

      if (!items.length) {
        wrap.innerHTML = `<div class="muted" style="padding:10px">ç›®å‰æ¸…å–®æ˜¯ç©ºçš„ã€‚</div>`;
        return;
      }

      for (const it of items) {
        const pid = it.productId;
        const name = escapeHtml(it.name);
        const pricePromo = escapeHtml(it.pricePromo || "");
        const tags = escapeHtml(it.tags || "");
        const img = escapeHtml(it.imageUrl || "");
        const createdAt = it.createdAt ? new Date(it.createdAt).toLocaleString() : "";

        const el = document.createElement("div");
        el.className = "item";
        el.dataset.pid = String(pid);

        el.innerHTML = `
          <div class="thumb">
            ${img ? `<img src="${img}" alt="">` : ``}
          </div>
          <div class="info">
            <div class="name">${name}</div>
            <div class="meta">${pricePromo}</div>
            ${tags ? `<div class="tags">${tags}</div>` : ``}
            ${createdAt ? `<div class="tags">åŠ å…¥æ™‚é–“ï¼š${escapeHtml(createdAt)}</div>` : ``}
          </div>
          <div class="actions">
            <button class="trash" title="åˆªé™¤" aria-label="åˆªé™¤">ğŸ—‘ï¸</button>
          </div>
        `;

        el.querySelector(".trash").onclick = async () => {
          await deleteItem(pid, el);
        };

        wrap.appendChild(el);
      }
    }

    async function fetchList(userId) {
      setMsg("è®€å–æ¸…å–®ä¸­â€¦");
      $("reloadBtn").disabled = true;

      const url = `${GET_LIST_URL}?userId=${encodeURIComponent(userId)}`;
      const res = await fetch(url, { method: "GET" });

      let data;
      try { data = await res.json(); }
      catch { throw new Error("GET æ¸…å–®å›å‚³ä¸æ˜¯ JSONï¼Œè«‹æª¢æŸ¥ n8n å›æ‡‰æ ¼å¼"); }

      // å…¼å®¹å…©ç¨®å›å‚³æ ¼å¼ï¼š[{items:...}] æˆ– {items:...}
      const items = Array.isArray(data?.items) ? data.items : (Array.isArray(data?.[0]?.items) ? data[0].items : []);
      renderList(items);
      setMsg("");
      $("reloadBtn").disabled = false;
    }

    async function deleteItem(productId, cardEl) {
      const userId = $("userId").textContent;
      if (!userId || userId === "-" || userId.includes("å°šæœªç™»å…¥")) return;

      const btn = cardEl.querySelector(".trash");
      btn.disabled = true;

      setMsg(`åˆªé™¤å•†å“ ${productId}â€¦`);

      const url = `${DELETE_BASE}/list/${encodeURIComponent(productId)}?userId=${encodeURIComponent(userId)}`;
      const res = await fetch(url, { method: "DELETE" });

      if (!res.ok) {
        setMsg("åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
        btn.disabled = false;
        return;
      }

      // UI ç›´æ¥ç§»é™¤å¡ç‰‡ï¼ˆå¿«ï¼‰
      cardEl.remove();
      $("count").textContent = String(document.querySelectorAll(".item").length);
      setMsg("");
    }

    async function main() {
      try {
        await liff.init({ liffId: LIFF_ID });
        $("status").textContent = "âœ… åˆå§‹åŒ–æˆåŠŸ";
        $("inClient").textContent = String(liff.isInClient());

        if (!liff.isLoggedIn()) {
          $("loginBtn").style.display = "inline-block";
          $("loginBtn").onclick = () => liff.login();
          $("userId").textContent = "(å°šæœªç™»å…¥)";
          return;
        }

        const profile = await liff.getProfile();
        $("userId").textContent = profile.userId;

        $("reloadBtn").style.display = "inline-block";
        $("reloadBtn").onclick = () => fetchList(profile.userId);

        if (liff.isInClient()) {
          $("closeBtn").style.display = "inline-block";
          $("closeBtn").onclick = () => liff.closeWindow();
        }

        await fetchList(profile.userId);
      } catch (e) {
        $("status").textContent = "âŒ åˆå§‹åŒ–å¤±æ•—";
        const msg = (e && (e.message || e.toString())) || "unknown";
        alert("LIFF init error: " + msg);
        console.error(e);
      }
    }

    main();
  </script>
</body>
</html>
