<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æˆ‘çš„æ¸…å–®ï¼ˆLIFFï¼‰</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --danger:#ef4444;
      --shadow:0 10px 25px rgba(0,0,0,.06);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width: 760px;
      margin: 0 auto;
      padding: 18px 14px 40px;
    }
    h1{
      margin: 8px 0 14px;
      font-size: 30px;
      letter-spacing: .5px;
    }
    .panel{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      margin-bottom: 14px;
    }
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border:1px solid var(--border);
      border-radius: 999px;
      background:#fff;
      font-size: 13px;
      color: var(--muted);
    }
    .ok{color:#16a34a}
    .fail{color:#dc2626}
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      word-break: break-all;
      background:#f3f4f6;
      border:1px solid var(--border);
      padding:10px;
      border-radius: 12px;
      width:100%;
      color:#111827;
      font-size: 13px;
    }
    button{
      border:1px solid var(--border);
      background:#fff;
      border-radius: 14px;
      padding:10px 14px;
      cursor:pointer;
      font-weight:600;
    }
    button:disabled{opacity:.6; cursor:not-allowed}
    .muted{color:var(--muted); font-size: 13px}
    .listHead{
      display:flex; align-items:center; justify-content:space-between;
      margin-top: 6px;
      margin-bottom: 8px;
      padding: 0 2px;
    }
    .cards{display:flex; flex-direction:column; gap: 12px;}
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      gap: 12px;
      padding: 12px;
      align-items: stretch;
    }
    .thumb{
      width: 112px;
      height: 112px;
      border-radius: 14px;
      overflow:hidden;
      background:#eee;
      flex: 0 0 auto;
      border: 1px solid var(--border);
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
    }
    .content{
      flex: 1 1 auto;
      min-width: 0;
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .title{
      font-size: 18px;
      font-weight: 800;
      line-height: 1.2;
      margin: 0;
      word-break: break-word;
    }
    .line{
      display:flex;
      gap: 8px;
      align-items:flex-start;
      color: var(--muted);
      font-size: 14px;
      line-height: 1.25;
      word-break: break-word;
    }
    .icon{width: 18px; flex: 0 0 auto}
    .actions{
      flex: 0 0 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      padding-left: 6px;
    }
    .trash{
      width: 44px;
      height: 44px;
      border-radius: 14px;
      border: 1px solid rgba(239,68,68,.35);
      background: rgba(239,68,68,.08);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .trash:hover{background: rgba(239,68,68,.13)}
    .trash svg{fill: var(--danger)}
    .errorBox{
      margin-top: 10px;
      color:#b91c1c;
      background:#fef2f2;
      border:1px solid #fecaca;
      padding: 10px;
      border-radius: 14px;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>æˆ‘çš„æ¸…å–®ï¼ˆLIFFï¼‰</h1>

    <div class="panel">
      <div class="row" style="justify-content:space-between;">
        <div class="row">
          <div class="badge">
            <span>ç‹€æ…‹ï¼š</span>
            <span id="liffStatus" class="muted">åˆå§‹åŒ–ä¸­â€¦</span>
          </div>
          <div class="badge">
            <span>æ˜¯å¦åœ¨ LINE Appï¼š</span>
            <span id="inClient" class="muted">-</span>
          </div>
        </div>

        <div class="row">
          <button id="btnReload">é‡æ–°è¼‰å…¥æ¸…å–®</button>
          <button id="btnClose" style="display:none;">é—œé–‰ LIFF</button>
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="muted">ä½ çš„ userIdï¼š</div>
      <div id="userIdBox" class="mono">(å°šæœªå–å¾—)</div>
      <div id="initError" class="errorBox" style="display:none;"></div>
    </div>

    <div class="panel">
      <div class="listHead">
        <div class="row" style="gap:8px;">
          <span style="font-size:18px;font-weight:800;">ğŸ§¾ æˆ‘çš„æ¸…å–®</span>
          <span class="muted" id="countText"></span>
        </div>
      </div>

      <div id="listError" class="errorBox" style="display:none;"></div>
      <div id="cards" class="cards"></div>
      <div id="empty" class="muted" style="display:none; padding: 6px 2px;">ç›®å‰æ²’æœ‰å•†å“</div>
    </div>
  </div>

<script>
  // ====== ä½ åªè¦æ”¹é€™å…©å€‹ ======
  const LIFF_ID = "2009075953-1UZ0h4p2";
  const API_BASE = "https://subdepressed-thistly-lee.ngrok-free.dev/webhook";
  const DELETE_BASE = "https://subdepressed-thistly-lee.ngrok-free.dev/webhook/9cc8ce9b-9837-4a04-b46d-7c4f9b772ce2";
  // =================================

  const els = {
    liffStatus: document.getElementById('liffStatus'),
    inClient: document.getElementById('inClient'),
    userIdBox: document.getElementById('userIdBox'),
    btnClose: document.getElementById('btnClose'),
    btnReload: document.getElementById('btnReload'),
    initError: document.getElementById('initError'),
    listError: document.getElementById('listError'),
    cards: document.getElementById('cards'),
    empty: document.getElementById('empty'),
    countText: document.getElementById('countText'),
  };

  function qs(name){
    const u = new URL(location.href);
    return u.searchParams.get(name);
  }

  function setInitError(msg){
    els.initError.style.display = msg ? 'block' : 'none';
    els.initError.textContent = msg || '';
  }

  function setListError(msg){
    els.listError.style.display = msg ? 'block' : 'none';
    els.listError.textContent = msg || '';
  }

  function escapeHtml(s){
    return String(s ?? '')
      .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
      .replaceAll('"','&quot;').replaceAll("'","&#039;");
  }

  function formatTime(iso){
    if (!iso) return '';
    const d = new Date(iso);
    if (isNaN(d.getTime())) return String(iso);
    return d.toLocaleString('zh-TW', { hour12: true });
  }

  async function fetchJson(url, options = {}){
    const opt = {
      ...options,
      headers: {
        'Accept': 'application/json',
        'ngrok-skip-browser-warning': '1',
        ...(options.headers || {})
      }
    };

    const res = await fetch(url, opt);
    const text = await res.text();

    // å˜—è©¦ parse JSON
    try {
      return { ok: true, status: res.status, json: JSON.parse(text), raw: text };
    } catch (e) {
      // å›å‚³ä¸æ˜¯ JSONï¼ˆå¸¸è¦‹ï¼šngrok çš„è­¦å‘Š HTMLï¼‰
      const head200 = text.slice(0, 200);
      return { ok: false, status: res.status, error: "å›å‚³ä¸æ˜¯ JSONï¼ˆå¯èƒ½æ‰“åˆ° HTML é ï¼‰", head200, raw: text };
    }
  }

  function buildCard(item){
    const name = item.name || '';
    const pricePromo = item.pricePromo || '';
    const tags = item.tags || '';
    const img = item.imageUrl || '';
    const createdAt = item.createdAt ? formatTime(item.createdAt) : '';

    const wrapper = document.createElement('div');
    wrapper.className = 'card';

    const thumb = document.createElement('div');
    thumb.className = 'thumb';
    thumb.innerHTML = img
      ? `<img src="${escapeHtml(img)}" alt="">`
      : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#9ca3af;font-weight:700;">No Img</div>`;

    const content = document.createElement('div');
    content.className = 'content';
    content.innerHTML = `
      <div class="title">${escapeHtml(name)}</div>
      <div class="line"><span class="icon">ğŸ’µ</span><span>${escapeHtml(pricePromo)}</span></div>
      <div class="line"><span class="icon">ğŸ·ï¸</span><span>${escapeHtml(tags)}</span></div>
      ${createdAt ? `<div class="line"><span class="icon">ğŸ•’</span><span>${escapeHtml(createdAt)}</span></div>` : ''}
    `;

    const actions = document.createElement('div');
    actions.className = 'actions';

    const btn = document.createElement('button');
    btn.className = 'trash';
    btn.title = 'åˆªé™¤';
    btn.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M9 3h6l1 2h4v2H4V5h4l1-2zm1 6h2v10h-2V9zm4 0h2v10h-2V9zM7 9h2v10H7V9z"/>
      </svg>
    `;

    btn.addEventListener('click', async () => {
      const productId = item.productId;
      if (!productId) return;

      if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€å—ï¼Ÿ`)) return;

      btn.disabled = true;
      setListError('');

      try{
        await deleteItem(productId);
        await loadList(); // åˆªå®Œé‡æŠ“
      }catch(err){
        setListError(String(err?.message || err));
      }finally{
        btn.disabled = false;
      }
    });

    actions.appendChild(btn);
    wrapper.appendChild(thumb);
    wrapper.appendChild(content);
    wrapper.appendChild(actions);
    return wrapper;
  }

  let CURRENT_USER_ID = '';

  async function loadList(){
    if (!CURRENT_USER_ID) {
      setListError('æ²’æœ‰ userIdï¼Œç„¡æ³•è¼‰å…¥æ¸…å–®');
      return;
    }

    setListError('');
    els.cards.innerHTML = '';
    els.empty.style.display = 'none';
    els.countText.textContent = '';

    const url = `${API_BASE}/list?userId=${encodeURIComponent(CURRENT_USER_ID)}`;
    const r = await fetchJson(url, { method: 'GET' });

    if (!r.ok){
      setListError(`${r.error}\nURL: ${url}\n\nå‰200å­—ï¼š\n${r.head200}`);
      return;
    }

    // ä½ çš„ n8n å›å‚³æ˜¯ä¸€å€‹é™£åˆ—ï¼Œç¬¬ä¸€å€‹å…ƒç´ å« items
    const payload = Array.isArray(r.json) ? r.json[0] : r.json;
    const items = payload?.items || [];
    const count = payload?.count ?? items.length ?? 0;

    els.countText.textContent = `(å…± ${count} ç­†)`;

    if (!items || items.length === 0){
      els.empty.style.display = 'block';
      return;
    }

    for (const it of items){
      els.cards.appendChild(buildCard(it));
    }
  }

  async function deleteItem(productId){
    // ä½ çš„åˆªé™¤ webhookï¼š/webhook/<uuid>/list/:productId
    const url = `${DELETE_BASE}/list/${encodeURIComponent(productId)}`;
  
    const r = await fetchJson(url, { method: 'DELETE' });
  
    if (!r.ok){
      throw new Error(`${r.error}\nURL: ${url}\n\nå‰200å­—ï¼š\n${r.head200}`);
    }
    return r.json;
  }

    // ä½  n8n ç¾åœ¨å›çš„æ˜¯ ok/userId/productId/rowToDelete ä¹‹é¡éƒ½å¯ä»¥
    return r.json;
  }

  async function init(){
    els.btnReload.addEventListener('click', loadList);

    // å…è¨±ä½ åœ¨ç€è¦½å™¨ç›´æ¥æ¸¬ï¼šindex.html?userId=Ub48...
    const fallbackUserId = qs('userId');

    try{
      await liff.init({ liffId: LIFF_ID });

      const inClient = liff.isInClient();
      els.inClient.textContent = String(inClient);

      if (inClient) els.btnClose.style.display = 'inline-block';
      els.btnClose.onclick = () => liff.closeWindow();

      let userId = fallbackUserId || '';

      if (!userId){
        // åªæœ‰åœ¨ LINE å…§æ‰æŠ“ profile
        if (inClient){
          const profile = await liff.getProfile();
          userId = profile.userId || '';
        }
      }

      if (!userId){
        els.liffStatus.textContent = 'âŒ åˆå§‹åŒ–æˆåŠŸä½†æ‹¿ä¸åˆ° userId';
        els.liffStatus.className = 'fail';
        els.userIdBox.textContent = '(å°šæœªå–å¾—)';
        setInitError('æ‹¿ä¸åˆ° userIdï¼šè«‹ç”¨ LINE å…§é–‹å•Ÿï¼Œæˆ–ç”¨ ?userId=xxx æ¸¬è©¦');
        return;
      }

      CURRENT_USER_ID = userId;
      els.userIdBox.textContent = userId;

      els.liffStatus.textContent = 'âœ… åˆå§‹åŒ–æˆåŠŸ';
      els.liffStatus.className = 'ok';

      await loadList();

    }catch(e){
      els.liffStatus.textContent = 'âŒ åˆå§‹åŒ–å¤±æ•—';
      els.liffStatus.className = 'fail';
      els.inClient.textContent = '-';
      els.userIdBox.textContent = '(å°šæœªå–å¾—)';
      setInitError('Invalid LIFF ID æˆ– LIFF åˆå§‹åŒ–éŒ¯èª¤ï¼š\n' + (e?.message || String(e)));
    }
  }

  init();
</script>
</body>
</html>
