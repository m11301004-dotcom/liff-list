<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æˆ‘çš„æ¸…å–®ï¼ˆLIFFï¼‰</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --danger:#ef4444;
      --shadow: 0 6px 18px rgba(17,24,39,.08);
      --radius: 14px;
    }
    body{
      margin:0;
      background:var(--bg);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Heiti TC", Arial, sans-serif;
      color:var(--text);
    }
    .wrap{
      max-width: 520px;
      margin: 0 auto;
      padding: 18px 14px 36px;
    }
    h1{
      font-size: 22px;
      margin: 6px 0 14px;
      font-weight: 800;
    }
    .panel{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      margin-bottom: 14px;
    }
    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size: 14px;
      color: var(--muted);
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      background:#f3f4f6;
      border:1px solid var(--border);
      padding: 6px 8px;
      border-radius: 10px;
      word-break: break-all;
    }
    .btn{
      appearance:none;
      border:1px solid var(--border);
      background:#fff;
      padding:10px 12px;
      border-radius: 12px;
      font-weight: 700;
      cursor:pointer;
    }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{
      border-color:#c7d2fe;
      background:#eef2ff;
    }
    .btn-danger{
      border-color:#fecaca;
      background:#fff1f2;
      color:#b91c1c;
    }
    .muted{ color: var(--muted); }

    /* list */
    .list{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top: 10px;
    }
    .card{
      display:grid;
      grid-template-columns: 92px 1fr 44px;
      gap: 12px;
      background: var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 12px;
      align-items: center;
    }
    .img{
      width:92px;
      height:92px;
      border-radius: 12px;
      border:1px solid var(--border);
      object-fit: cover;
      background:#fff;
    }
    .title{
      font-size: 15px;
      font-weight: 800;
      line-height: 1.2;
      margin-bottom: 6px;
    }
    .meta{
      font-size: 13px;
      color: var(--muted);
      line-height: 1.35;
    }
    .meta .line{ margin-top: 4px; }
    .trash{
      display:flex;
      align-items:center;
      justify-content:center;
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border:1px solid #fecaca;
      background:#fff;
      cursor:pointer;
    }
    .trash svg{ width: 20px; height: 20px; fill: var(--danger); }
    .trash:active{ transform: translateY(1px); }

    .err{
      white-space: pre-wrap;
      color:#b91c1c;
      font-size: 13px;
      background:#fff1f2;
      border:1px solid #fecaca;
      border-radius: 12px;
      padding: 10px;
      margin-top: 10px;
    }
    .ok{
      color:#065f46;
      font-size: 13px;
      background:#ecfdf5;
      border:1px solid #a7f3d0;
      border-radius: 12px;
      padding: 10px;
      margin-top: 10px;
      white-space: pre-wrap;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>æˆ‘çš„æ¸…å–®ï¼ˆLIFFï¼‰</h1>

    <div class="panel">
      <div class="row">
        <div class="badge">ç‹€æ…‹ï¼š<span id="status">åˆå§‹åŒ–ä¸­â€¦</span></div>
        <div class="badge">æ˜¯å¦åœ¨ LINE Appï¼š<span id="inLine">-</span></div>
      </div>
      <div style="margin-top:10px;">
        <div class="badge">ä½ çš„ userIdï¼š</div>
        <div class="mono" id="userIdBox">(å°šæœªå–å¾—)</div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="btn" id="btnClose">é—œé–‰ LIFF</button>
        <button class="btn btn-primary" id="btnReload">é‡æ–°è¼‰å…¥æ¸…å–®</button>
      </div>

      <div id="msg"></div>
    </div>

    <div class="panel">
      <div class="row">
        <div style="font-weight:900;">ğŸ§¾ æˆ‘çš„æ¸…å–®</div>
        <div class="muted" id="countText">-</div>
      </div>

      <div class="list" id="list"></div>
    </div>
  </div>

<script>
  /***********************
   * ä½ åªè¦æ”¹é€™å…©å€‹åœ°æ–¹
   ***********************/
  const LIFF_ID = "YOUR_LIFF_ID_HERE";

  // âœ… ä¸€å®šè¦è²¼ã€ŒProduction URL çš„ baseã€(å« UUID)ï¼š
  // ä¾‹ï¼šhttps://subdepressed-thistly-lee.ngrok-free.dev/webhook/9cc8ce9b-9837-4a04-b46d-7c4f9b772ce2
  const API_BASE = "https://subdepressed-thistly-lee.ngrok-free.dev/webhook/YOUR_WEBHOOK_UUID";

  // ä½ çš„ n8n ç«¯å¦‚æœæ˜¯ï¼š
  // GET  /list?userId=...
  // DELETE /list/:productId?userId=...
  const API_LIST_URL = `${API_BASE}/list`;
  const API_DELETE_URL = (productId) => `${API_BASE}/list/${encodeURIComponent(productId)}`;

  let currentUserId = "";

  function setMsg(type, text){
    const el = document.getElementById("msg");
    if(!text){ el.innerHTML = ""; return; }
    el.innerHTML = `<div class="${type === 'ok' ? 'ok' : 'err'}">${escapeHtml(text)}</div>`;
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  async function fetchJson(url, options = {}){
    const res = await fetch(url, {
      ...options,
      headers: {
        // âœ… é‡è¦ï¼šé¿å… ngrok ERR_NGROK_6024
        "ngrok-skip-browser-warning": "true",
        "Accept": "application/json",
        ...(options.headers || {})
      }
    });

    const text = await res.text();
    const ct = (res.headers.get("content-type") || "").toLowerCase();

    // æœ‰äº›æƒ…æ³å¾Œç«¯æ²’è¨­ content-type ä¹Ÿèƒ½ parseï¼Œæ‰€ä»¥ç”¨ã€Œé¦–å­—ã€ä¹Ÿåˆ¤æ–·ä¸€ä¸‹
    const looksJson = text.trim().startsWith("{") || text.trim().startsWith("[");

    if(!looksJson){
      throw new Error(
`å›å‚³ä¸æ˜¯ JSONï¼ˆå¯èƒ½è¢« ngrok æ“‹ã€æˆ–æ‰“åˆ°é webhookï¼‰
URL: ${url}
status: ${res.status}
content-type: ${ct || "(none)"}

å‰ 200 å­—ï¼š
${text.slice(0,200)}`
      );
    }

    try{
      return JSON.parse(text);
    }catch(e){
      throw new Error(`JSON è§£æå¤±æ•—ï¼š${e.message}\nå‰200å­—:\n${text.slice(0,200)}`);
    }
  }

  function renderList(items){
    const list = document.getElementById("list");
    const countText = document.getElementById("countText");

    if(!Array.isArray(items) || items.length === 0){
      list.innerHTML = `<div class="muted" style="padding:10px 2px;">ç›®å‰æ²’æœ‰å•†å“</div>`;
      countText.textContent = "0";
      return;
    }

    countText.textContent = String(items.length);

    list.innerHTML = items.map(it => {
      const name = it.name ?? "(ç„¡åç¨±)";
      const pricePromo = it.pricePromo ?? "";
      const tags = it.tags ?? "";
      const imageUrl = it.imageUrl ?? "";
      const createdAt = it.createdAt ? new Date(it.createdAt).toLocaleString() : "";

      return `
        <div class="card" data-productid="${escapeHtml(it.productId)}">
          <img class="img" src="${escapeHtml(imageUrl)}" alt="">
          <div>
            <div class="title">${escapeHtml(name)}</div>
            <div class="meta">
              ${pricePromo ? `<div class="line">ğŸ’µ ${escapeHtml(pricePromo)}</div>` : ""}
              ${tags ? `<div class="line">ğŸ·ï¸ ${escapeHtml(tags)}</div>` : ""}
              ${createdAt ? `<div class="line">ğŸ•’ ${escapeHtml(createdAt)}</div>` : ""}
              <div class="line muted">ID: ${escapeHtml(it.productId)}</div>
            </div>
          </div>
          <button class="trash" title="åˆªé™¤" onclick="onDelete('${escapeHtml(it.productId)}')">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M9 3h6l1 2h4v2H4V5h4l1-2zm1 6h2v9h-2V9zm4 0h2v9h-2V9zM7 9h2v9H7V9zm-1 12h12a2 2 0 0 0 2-2V9H4v10a2 2 0 0 0 2 2z"/>
            </svg>
          </button>
        </div>
      `;
    }).join("");
  }

  async function loadList(){
    if(!currentUserId){
      setMsg("err", "å°šæœªå–å¾— userIdï¼Œè«‹å…ˆå®Œæˆ LIFF ç™»å…¥ã€‚");
      return;
    }

    const url = `${API_LIST_URL}?userId=${encodeURIComponent(currentUserId)}`;

    setMsg("ok", `è¼‰å…¥ä¸­â€¦\nAPI: ${url}`);
    try{
      const data = await fetchJson(url);

      // ä½ çš„ n8n å›å‚³å¯èƒ½æ˜¯ï¼š
      // 1) [ { ok:true, items:[...]} ]
      // 2) { ok:true, items:[...] }
      const payload = Array.isArray(data) ? data[0] : data;
      const items = payload?.items || [];

      renderList(items);
      setMsg("", "");
    }catch(e){
      renderList([]);
      setMsg("err", e.message);
    }
  }

  // è®“ inline onclick å¯ç”¨
  window.onDelete = async function(productId){
    if(!currentUserId) return;

    const ok = confirm(`ç¢ºå®šè¦åˆªé™¤å•†å“ ID=${productId} å—ï¼Ÿ`);
    if(!ok) return;

    const url = `${API_DELETE_URL(productId)}?userId=${encodeURIComponent(currentUserId)}`;

    setMsg("ok", `åˆªé™¤ä¸­â€¦\nAPI: ${url}`);

    try{
      // ä½ çš„ n8n DELETE webhook è‹¥éœ€è¦ method DELETEï¼š
      const res = await fetchJson(url, { method: "DELETE" });

      // åˆªé™¤å¾Œé‡è¼‰
      await loadList();
    }catch(e){
      setMsg("err", e.message);
    }
  };

  async function init(){
    document.getElementById("btnClose").onclick = () => liff.closeWindow();
    document.getElementById("btnReload").onclick = () => loadList();

    try{
      await liff.init({ liffId: LIFF_ID });
      document.getElementById("status").textContent = "âœ… åˆå§‹åŒ–æˆåŠŸ";
      document.getElementById("inLine").textContent = String(liff.isInClient());

      if(!liff.isLoggedIn()){
        // LIFF å¤–é–‹ä¹Ÿå¯èƒ½éœ€è¦ login
        liff.login({ redirectUri: location.href });
        return;
      }

      const profile = await liff.getProfile();
      currentUserId = profile.userId;
      document.getElementById("userIdBox").textContent = currentUserId;

      await loadList();
    }catch(e){
      document.getElementById("status").textContent = "âŒ åˆå§‹åŒ–å¤±æ•—";
      setMsg("err", `LIFF init error: ${e.message}`);
    }
  }

  init();
</script>
</body>
</html>
