<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æˆ‘çš„æ¸…å–®ï¼ˆLIFFï¼‰</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Arial; padding: 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin-top: 12px; }
    code { background:#f6f6f6; padding:2px 6px; border-radius:6px; }
    button { padding:10px 12px; border-radius:10px; border:1px solid #ccc; background:#fff; cursor: pointer; }

    /* âœ… Step1: æ¸…å–® UI éª¨æ¶ */
    .listWrap { margin-top: 12px; }
    .listHeader { display:flex; align-items:center; justify-content:space-between; gap: 12px; }
    .muted { color:#666; font-size: 14px; }
    .items { display:flex; flex-direction:column; gap:12px; margin-top:12px; }
    .itemCard { display:flex; gap:12px; border:1px solid #eee; border-radius:14px; padding:12px; }
    .thumb { width:86px; height:86px; border-radius:12px; background:#f2f2f2; flex:0 0 auto; object-fit:cover; }
    .meta { flex:1 1 auto; min-width:0; }
    .name { font-weight:700; line-height:1.25; word-break: break-word; }
    .sub { margin-top:6px; color:#444; font-size:14px; word-break: break-word; }
  </style>
</head>

<body>
  <h2>LIFF æ¸¬è©¦é </h2>

  <div class="card">
    <div>ç‹€æ…‹ï¼š<span id="status">åˆå§‹åŒ–ä¸­â€¦</span></div>
    <div style="margin-top:8px;">æ˜¯å¦åœ¨ LINE Appï¼š<code id="inClient">-</code></div>
    <div style="margin-top:8px;">ä½ çš„ userIdï¼š<code id="userId">-</code></div>
  </div>

  <div class="card">
    <button id="loginBtn" style="display:none;">ç™»å…¥ LINE</button>
    <button id="closeBtn" style="display:none; margin-left:8px;">é—œé–‰ LIFF</button>
  </div>

  <!-- âœ… Step1: æˆ‘çš„æ¸…å–®å€å¡Š -->
  <div class="card listWrap">
    <div class="listHeader">
      <div>ğŸ§¾ æˆ‘çš„æ¸…å–®</div>
      <div class="muted" id="listHint">å°šæœªè¼‰å…¥</div>
    </div>
    <div class="items" id="items"></div>
  </div>

  <script>
    // âš ï¸ Step1 åªåš UI/æµç¨‹é©—è­‰ï¼šå…ˆä¸æ‰“ n8n API
    // è«‹æŠŠé€™è£¡æ›æˆä½ çš„ LIFF ID
    const LIFF_ID = "2009075953-1UZ0h4p2";

    const $ = (id) => document.getElementById(id);

    // âš ï¸ æ›æˆä½ çš„ Production Webhook åŸºç¤ç¶²å€ï¼ˆä¸è¦å« userIdï¼‰
    const API_BASE = "https://subdepressed-thistly-lee.ngrok-free.dev/webhook";
    
    async function loadList(userId) {
      $("listHint").textContent = "è¼‰å…¥ä¸­â€¦";
      const itemsEl = $("items");
      itemsEl.innerHTML = "";
    
      try {
        const res = await fetch(`${API_BASE}/list?userId=${encodeURIComponent(userId)}`);
        const data = await res.json();
    
        if (!data.ok || !Array.isArray(data.items)) {
          throw new Error("API å›å‚³æ ¼å¼éŒ¯èª¤");
        }
    
        if (data.items.length === 0) {
          itemsEl.innerHTML = `<div class="muted">ç›®å‰æ²’æœ‰å•†å“</div>`;
          $("listHint").textContent = "æ¸…å–®ç‚ºç©º";
          return;
        }
    
        for (const item of data.items) {
          const card = document.createElement("div");
          card.className = "itemCard";
    
          card.innerHTML = `
            <img class="thumb" src="${item.imageUrl || ''}" alt="">
            <div class="meta">
              <div class="name">${escapeHtml(item.name || '')}</div>
              <div class="sub">${escapeHtml(item.pricePromo || '')}</div>
              <div class="sub muted">${escapeHtml(item.tags || '')}</div>
            </div>
          `;
    
          itemsEl.appendChild(card);
        }
    
        $("listHint").textContent = `å…± ${data.items.length} ç­†`;
    
      } catch (err) {
        console.error(err);
        itemsEl.innerHTML = `<div class="muted">è¼‰å…¥å¤±æ•—</div>`;
        $("listHint").textContent = "éŒ¯èª¤";
      }
    }
    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function main() {
      try {
        await liff.init({ liffId: LIFF_ID });
        $("status").textContent = "âœ… åˆå§‹åŒ–æˆåŠŸ";
        $("inClient").textContent = String(liff.isInClient());

        if (!liff.isLoggedIn()) {
          $("loginBtn").style.display = "inline-block";
          $("loginBtn").onclick = () => liff.login();
          $("userId").textContent = "(å°šæœªç™»å…¥)";
          return;
        }

        const profile = await liff.getProfile();
        $("userId").textContent = profile.userId;

        // âœ… Step1: æ‹¿åˆ° userId å¾Œå…ˆè·‘ä¸€æ¬¡ UI æ¸¬è©¦è¼‰å…¥
        await loadList(profile.userId);

        if (liff.isInClient()) {
          $("closeBtn").style.display = "inline-block";
          $("closeBtn").onclick = () => liff.closeWindow();
        }
      } catch (e) {
        $("status").textContent = "âŒ åˆå§‹åŒ–å¤±æ•—";
        const msg = (e && (e.message || e.toString())) || "unknown";
        alert("LIFF init error: " + msg);
        console.error(e);
      }
    }

    main();
  </script>
</body>
</html>


