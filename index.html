<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æˆ‘çš„æ¸…å–®ï¼ˆLIFFï¼‰</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --card:#ffffff;
      --border:#e9e9e9;
      --text:#111;
      --muted:#666;
      --danger:#d32f2f;
      --bg:#fafafa;
    }
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Arial;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 16px;
    }
    h2{ margin: 8px 0 12px; }
    .panel{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      margin-top: 12px;
    }
    code{
      background:#f3f3f3;
      padding:2px 6px;
      border-radius: 8px;
      word-break: break-all;
    }
    .btn{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ccc;
      background:#fff;
      cursor:pointer;
    }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .spacer{ flex:1; }

    .listHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .muted{ color: var(--muted); font-size: 14px; }

    .items{
      display:flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 12px;
    }

    .itemCard{
      display:flex;
      gap:12px;
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      background:#fff;
    }
    .thumb{
      width: 92px;
      height: 92px;
      border-radius: 14px;
      background:#f1f1f1;
      object-fit: cover;
      flex: 0 0 auto;
    }
    .meta{
      flex: 1 1 auto;
      min-width: 0;
    }
    .name{
      font-weight: 800;
      line-height: 1.25;
      word-break: break-word;
    }
    .sub{
      margin-top: 6px;
      font-size: 14px;
      color:#333;
      word-break: break-word;
    }
    .tags{
      margin-top: 6px;
      font-size: 13px;
      color: var(--muted);
      word-break: break-word;
    }

    .err{
      margin-top: 10px;
      color: var(--danger);
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>

<body>
  <h2>LIFF æ¸¬è©¦é </h2>

  <div class="panel">
    <div>ç‹€æ…‹ï¼š<span id="status">åˆå§‹åŒ–ä¸­â€¦</span></div>
    <div style="margin-top:8px;">æ˜¯å¦åœ¨ LINE Appï¼š<code id="inClient">-</code></div>
    <div style="margin-top:8px;">ä½ çš„ userIdï¼š<code id="userId">-</code></div>
  </div>

  <div class="panel">
    <div class="row">
      <button id="loginBtn" class="btn" style="display:none;">ç™»å…¥ LINE</button>
      <button id="closeBtn" class="btn" style="display:none;">é—œé–‰ LIFF</button>
      <div class="spacer"></div>
      <button id="reloadBtn" class="btn" style="display:none;">é‡æ–°è¼‰å…¥æ¸…å–®</button>
    </div>
  </div>

  <div class="panel">
    <div class="listHeader">
      <div>ğŸ§¾ æˆ‘çš„æ¸…å–®</div>
      <div class="muted" id="listHint">å°šæœªè¼‰å…¥</div>
    </div>

    <div class="items" id="items"></div>

    <div class="err" id="errBox" style="display:none;"></div>
    <div class="muted" id="debugBox" style="display:none; margin-top:8px;"></div>
  </div>

  <script>
    // âœ… ä½ çš„ LIFF ID
    const LIFF_ID = "2009075953-1UZ0h4p2";

    // âœ… æ”¹ç”¨ä½ å·²ç¢ºèªèƒ½å› JSON çš„ endpointï¼ˆé‡é»ï¼‰
    // GET:  /webhook/list?userId=xxxx
    const API_LIST_URL = "https://subdepressed-thistly-lee.ngrok-free.dev/webhook/list";

    const $ = (id) => document.getElementById(id);

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function showErr(msg) {
      $("errBox").style.display = "block";
      $("errBox").textContent = msg;
    }
    function clearErr() {
      $("errBox").style.display = "none";
      $("errBox").textContent = "";
    }

    function showDebug(msg) {
      const d = $("debugBox");
      d.style.display = "block";
      d.textContent = msg;
    }

    function renderItems(items) {
      const el = $("items");
      el.innerHTML = "";

      if (!items || items.length === 0) {
        el.innerHTML = `<div class="muted">ç›®å‰æ²’æœ‰å•†å“</div>`;
        return;
      }

      for (const it of items) {
        const card = document.createElement("div");
        card.className = "itemCard";
        card.innerHTML = `
          <img class="thumb" src="${escapeHtml(it.imageUrl)}" alt="">
          <div class="meta">
            <div class="name">${escapeHtml(it.name)}</div>
            <div class="sub">${escapeHtml(it.pricePromo)}</div>
            <div class="tags">${escapeHtml(it.tags)}</div>
          </div>
        `;
        el.appendChild(card);
      }
    }

    async function loadList(userId) {
      $("listHint").textContent = "è¼‰å…¥ä¸­â€¦";
      clearErr();

      const url = `${API_LIST_URL}?userId=${encodeURIComponent(userId)}`;
      showDebug(`API: ${url}`);

      try {
        const res = await fetch(url, { method: "GET" });
        const text = await res.text(); // å…ˆè®€ textï¼Œé¿å…é JSON ç›´æ¥çˆ†

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}\nURL: ${url}\n\n${text.slice(0, 400)}`);
        }

        let data;
        try {
          data = JSON.parse(text);
        } catch (e) {
          throw new Error(`å›å‚³ä¸æ˜¯ JSONï¼ˆå¯èƒ½æ‰“åˆ° HTML é ï¼‰\nURL: ${url}\n\nå‰ 200 å­—ï¼š\n${text.slice(0, 1000)}`);
        }

        // ä½  n8n å›å‚³å¯èƒ½æ˜¯ array: [ { ok:true, items:[...]} ]
        if (Array.isArray(data)) data = data[0];

        if (!data || data.ok !== true || !Array.isArray(data.items)) {
          throw new Error(`JSON æ ¼å¼ä¸ç¬¦é æœŸ\nURL: ${url}\n\næ”¶åˆ°ï¼š${text.slice(0, 400)}`);
        }

        renderItems(data.items);
        $("listHint").textContent = `å…± ${data.items.length} ç­†`;

      } catch (err) {
        console.error(err);
        $("listHint").textContent = "éŒ¯èª¤";
        renderItems([]);
        showErr(String(err && err.message ? err.message : err));
      }
    }

    async function main() {
      try {
        await liff.init({ liffId: LIFF_ID });
        $("status").textContent = "âœ… åˆå§‹åŒ–æˆåŠŸ";
        $("inClient").textContent = String(liff.isInClient());

        if (!liff.isLoggedIn()) {
          $("loginBtn").style.display = "inline-block";
          $("loginBtn").onclick = () => liff.login();
          $("userId").textContent = "(å°šæœªç™»å…¥)";
          return;
        }

        const profile = await liff.getProfile();
        $("userId").textContent = profile.userId;

        $("reloadBtn").style.display = "inline-block";
        $("reloadBtn").onclick = () => loadList(profile.userId);

        await loadList(profile.userId);

        if (liff.isInClient()) {
          $("closeBtn").style.display = "inline-block";
          $("closeBtn").onclick = () => liff.closeWindow();
        }

      } catch (e) {
        $("status").textContent = "âŒ åˆå§‹åŒ–å¤±æ•—";
        const msg = (e && (e.message || e.toString())) || "unknown";
        alert("LIFF init error: " + msg);
        console.error(e);
      }
    }

    main();
  </script>
</body>
</html>

