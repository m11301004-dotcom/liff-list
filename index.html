<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>æˆ‘çš„æ¸…å–®ï¼ˆLIFFï¼‰</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans TC";
  background:#f5f6fa;
}
.wrap{
  max-width:760px;
  margin:auto;
  padding:20px;
}
h1{margin:10px 0 20px;font-size:28px;}
.panel{
  background:white;
  padding:15px;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.06);
  margin-bottom:20px;
}
.mono{
  background:#f1f2f6;
  padding:8px;
  border-radius:10px;
  font-size:13px;
  word-break:break-all;
}
.cards{
  display:flex;
  flex-direction:column;
  gap:12px;
}
.card{
  display:flex;
  gap:12px;
  background:white;
  border-radius:18px;
  padding:12px;
  box-shadow:0 10px 25px rgba(0,0,0,.06);
  align-items:center;
}
.thumb{
  width:110px;
  height:110px;
  border-radius:14px;
  overflow:hidden;
  flex-shrink:0;
}
.thumb img{
  width:100%;
  height:100%;
  object-fit:cover;
}
.content{
  flex:1;
}
.title{
  font-size:18px;
  font-weight:800;
  margin-bottom:6px;
}
.line{
  font-size:14px;
  color:#666;
  margin-bottom:4px;
}
.trash{
  width:46px;
  height:46px;
  border-radius:14px;
  background:#ffeaea;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
.trash:hover{
  background:#ffd6d6;
}
button{
  padding:8px 12px;
  border-radius:12px;
  border:1px solid #ddd;
  background:white;
}
.error{
  color:red;
  font-size:13px;
  white-space:pre-wrap;
}
</style>
</head>

<body>
<div class="wrap">
<h1>æˆ‘çš„æ¸…å–®ï¼ˆLIFFï¼‰</h1>

<div class="panel">
<div>ç‹€æ…‹ï¼š<span id="status">åˆå§‹åŒ–ä¸­...</span></div>
<div>ä½ çš„ userIdï¼š</div>
<div id="userId" class="mono">(å°šæœªå–å¾—)</div>
<br>
<!-- <button onclick="loadList()">é‡æ–°è¼‰å…¥æ¸…å–®</button> -->
<div id="error" class="error"></div>
</div>

<div class="cards" id="cards"></div>
</div>

<script>

const LIFF_ID = "2009075953-1UZ0h4p2"

const GET_API =
"https://subdepressed-thistly-lee.ngrok-free.dev/webhook/list"

const DELETE_API =
"https://subdepressed-thistly-lee.ngrok-free.dev/webhook/9cc8ce9b-9837-4a04-b46d-7c4f9b772ce2"

let CURRENT_USER = ""

async function fetchJson(url, options={}){
  const res = await fetch(url,{
    ...options,
    headers:{
      'ngrok-skip-browser-warning':'1',
      ...(options.headers||{})
    }
  })
  const text = await res.text()
  try{
    return {ok:true,data:JSON.parse(text)}
  }catch{
    return {ok:false,error:text.slice(0,200)}
  }
}

async function deleteItem(productId){
  // âœ… å¸¶ userIdï¼Œç¬¦åˆä½ ç¾åœ¨ n8n delete çš„è¼¸å…¥
  const url = `${DELETE_API}/list/${productId}?userId=${encodeURIComponent(CURRENT_USER)}`
  const r = await fetchJson(url,{method:'DELETE'})
  if(!r.ok){
    throw new Error(r.error)
  }
}

function createCard(item){
  const card=document.createElement("div")
  card.className="card"

  card.innerHTML=`
  <div class="thumb">
    <img src="${item.imageUrl||''}">
  </div>
  <div class="content">
    <div class="title">${item.name||''}</div>
    <div class="line">ğŸ’µ ${item.pricePromo||''}</div>
    <div class="line">ğŸ·ï¸ ${item.tags||''}</div>
    <div class="line">ğŸ•’ ${item.createdAt||''}</div>
  </div>
  <div class="trash">ğŸ—‘ï¸</div>
  `

  card.querySelector(".trash").onclick=async()=>{
    if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ"))return
    try{
      await deleteItem(item.productId)
      await loadList() // æœ€ç©©ï¼šé‡æŠ“ä¸€æ¬¡ï¼Œç¢ºä¿ UI èˆ‡ Sheet åŒæ­¥
    }catch(e){
      document.getElementById("error").textContent=e.message
    }
  }

  return card
}

async function loadList(){
  if(!CURRENT_USER)return

  document.getElementById("error").textContent=""
  const r=await fetchJson(`${GET_API}?userId=${encodeURIComponent(CURRENT_USER)}`)
  if(!r.ok){
    document.getElementById("error").textContent=r.error
    return
  }

  const payload=Array.isArray(r.data)?r.data[0]:r.data
  const items=payload.items||[]

  const container=document.getElementById("cards")
  container.innerHTML=""

  items.forEach(i=>{
    container.appendChild(createCard(i))
  })
}

async function init(){
  try{
    await liff.init({liffId:LIFF_ID})
    document.getElementById("status").textContent="åˆå§‹åŒ–æˆåŠŸ"

    const profile=await liff.getProfile()
    CURRENT_USER=profile.userId
    document.getElementById("userId").textContent=CURRENT_USER

    loadList()

  }catch(e){
    document.getElementById("status").textContent="åˆå§‹åŒ–å¤±æ•—"
    document.getElementById("error").textContent=e.message
  }
}

init()

</script>
</body>
</html>

